---
title: The schema registry
description: A central hub for your data graph
---

import ProjectConfigPanel from "gatsby-theme-apollo-docs/shared/project-config-panel.mdx";
import VideoFrame from "../components/video-frame";

Apollo Graph Manager provides a **schema registry** that serves as a central hub for managing your data graph (as recommended by [Principled GraphQL](https://principledgraphql.com/integrity#3-track-the-schema-in-a-registry)). The schema registry enables you to explore your schema's types and fields, track its change history, and improve your production server's security by removing the need for introspection. You can also [register **variants** of your schema](#managing-environments-with-variants) to support environments besides production, such as test or staging.

<VideoFrame
  title="Tracking your GraphQL Schema in a Registry"
  src="https://www.youtube.com/embed/duwM95RsiBs"
/>

## Registering your schema automatically (recommended)

> Automatic schema registration is available in Apollo Server v2.14 and later.

If you use [Apollo Server](https://www.apollographql.com/docs/apollo-server/), you can configure it to register its schema with Graph Manager automatically every time it starts up.

To do so, first obtain a **graph API key**:

<ObtainGraphApiKey />

After you obtain a graph API key, set it as the value of the `APOLLO_KEY` environment variable in your server's environment.

### Automatic registration to a particular variant

Your server can optionally report its schema to a particular [variant of your graph](#managing-environments-with-variants). To set this up, also set the `APOLLO_GRAPH_VARIANT` environment variable in your server's environment:

```sh
APOLLO_GRAPH_VARIANT=staging
```

If you don't specify a variant, Apollo Server reports its schema to the default variant (named `current`).

## Registering your schema manually

If you're using an older version of Apollo Server or another GraphQL server that doesn't support automatic schema registration, you can register your schema via the [Apollo CLI](https://www.apollographql.com/docs/devtools/cli/).

First, complete the following setup for your project:

<ProjectConfigPanel />

Now you can run the `apollo service:push` command from your application's root directory, like so:

```
$ apollo service:push
  ✔ Loading Apollo Project
  ✔ Uploading service to Engine

id      schema        tag
──────  ────────────  ───────
190330  example-4218  current
```

The CLI fetches your schema via a configuration option you set up in the project configuration above and pushes it to Graph Manager.

Every time you push a new version of your schema, it's appended to your graph's schema history.

### Manual registration to a particular variant

To register a schema to a particular [variant of your graph](#managing-environments-with-variants), include the `--variant=<VARIANT>` flag in your `apollo service:push` command, like so:

```bash
apollo service:push --variant=beta
```

If you omit the `--variant` flag, the `apollo service:push` command pushes to the default graph variant, named `current`.

## Registering a schema via continuous delivery

To get the most out of Graph Manager, you should **register each update to your production schema as soon as it occurs**. Consequently, schema registration should be part of your continuous delivery pipeline.

If you're using [automatic schema registration](#registering-your-schema-automatically-recommended), registration happens automatically each time you deploy your production server. No additional continuous delivery configuration is required.

If you're [registering via the Apollo CLI](#registering-your-schema-via-the-apollo-cli), include a call to `apollo service:push` in your continuous delivery pipeline.

Here's a sample continuous delivery configuration for pushing a schema to Apollo using CircleCI:

```yaml{13,29-31}
version: 2

jobs:
  build:
    docker:
      - image: circleci/node:8

    steps:
      - checkout

      - run: npm install
      # CircleCI needs global installs to be sudo
      - run: sudo npm install --global apollo

      # Start the GraphQL server.  If a different command is used to
      # start the server, use it in place of `npm start` here.
      - run:
          name: Starting server
          command: npm start
          background: true

      # make sure the server has enough time to start up before running
      # commands against it
      - run: sleep 5

      # When running on the 'master' branch, push the latest version
      # of the schema to Apollo Graph Manager.
      - run: |
          if [ "${CIRCLE_BRANCH}" == "master" ]; then
            apollo service:push --variant=master
          fi
```

## Viewing schema change history

The History view in Graph Manager lets you view the timeline of changes made to your schema:

![Schema history page in the Graph Manager UI](./img//schema-history.png)

**Only schema changes that you push to Graph Manager are included in this timeline**, which is one of the most important reasons to [include schema registration in your continuous delivery pipeline](#registering-a-schema-via-continuous-delivery).

## Managing environments with variants

Commonly, your application's staging and test environments use schemas that differ slightly from your production schema (especially if you're testing out updates to your schema).

Because these schemas represent different environments of the same application, it makes sense to associate them with each other. To achieve this, you can define **variants** of your graph.

Each variant of a graph functions as a standalone graph. It has its own change history, metrics, and operation registry.

### Registering a schema to a variant

* [Using automatic registration](#automatic-registration-to-a-particular-variant)
* [Using the Apollo CLI](#manual-registration-to-a-particular-variant)

### Associating metrics with a variant

You can configure Apollo Server to associate the metrics it sends to Graph Manager with a particular variant. To do so, set the `APOLLO_GRAPH_VARIANT` environment variable (`ENGINE_SCHEMA_TAG` in `apollo-server` pre-2.13.0) to the appropriate variant before initializing Apollo Server.

Alternatively, you can include the `graphVariant` (`schemaTag` in `apollo-server` pre-2.13.0) option in your call to the `ApolloServer` constructor, like so:

```js
const server = new ApolloServer({
  ...
  engine: {
    apiKey: "<APOLLO_KEY>",
    graphVariant: "beta" // highlight-line
  }
});
```

> Make sure you associate Apollo Server's metrics with the correct variant! Otherwise, metrics from your staging and test environments will be included in reports for your production graph.

## Tools that use the schema registry

Keeping your registered schema up to date ensures that you get the best possible experience from Apollo tools that connect to the registry:

- The [Apollo VS Code extension](https://marketplace.visualstudio.com/items?itemName=apollographql.vscode-apollo) provides built-in linting on queries by validating against your registered schema. It also annotates fields with their descriptions and with performance indicators collected in Apollo's trace warehouse.
- The [schema validation](/schema-validation/) workflow protects your team from accidentally making breaking schema changes. It creates a diff between your local schema and the last schema pushed to the registry, and validates this diff against live traffic seen on your endpoint to warn you about problematic changes.
- Your schema's full history and current usage can be seen in [Apollo Graph Manager](https://engine.apollographql.com). The History page tracks changes made over time, and the Explorer page shows which clients and which queries are using each field in your schema.
